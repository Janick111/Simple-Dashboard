{% extends "bootstrap/base.html" %}

{% block title %}Manage Sales Data{% endblock %}

{% block styles %}
{{super()}}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="../#">Dashboard</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/">Dashboard</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="/add-sales">Manage Sales Data</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container">
    <h1 class="text-center mt-4 mb-4">Manage Sales Data</h1>

    <!-- Action buttons -->
    <div class="mb-3">
        <button class="btn btn-primary" onclick="openAddModal()">Add Entry</button>
        <button class="btn btn-secondary" onclick="openEditModal()">Edit Entry</button>
        <button class="btn btn-danger" onclick="deleteEntry()">Delete Entry</button>
    </div>

    <!-- Table of existing sales data -->
    <table class="table table-striped">
        <thead>
            <tr>
                {% for col in ['Year', 'Month', 'Sales', 'Category'] %}
                  <th>
                    <a href="?order_by={{ col }}&order_dir={% if order_by == col and order_dir == 'asc' %}desc{% else %}asc{% endif %}">
                      {{ col }}
                      {% if order_by == col %}
                        {% if order_dir == 'asc' %}
                          ▲
                        {% else %}
                          ▼
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in sales_data.itertuples() %}
              <tr onclick="selectRow(this, '{{ row.index }}', '{{ row.Category }}', '{{ row.Year }}', '{{ row.Month }}', '{{ row.Sales}}')"
                  data-index="{{ row.index }}"
                  data-category="{{ row.Category }}"
                  data-year="{{ row.Year }}"
                  data-month="{{ row.Month }}"
                  data-sales="{{ row.Sales }}">
                <td>{{ row.Year }}</td>
                <td>{{ row.Month }}</td>
                <td>€{{ "{:,.2f}".format(row.Sales) }}</td>
                <td>{{ row.Category }}</td>
              </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for Add/Edit form -->
<div class="modal" id="salesModal">
    <div class="modal-content">
        <h2 id="salesModalLabel">{{ 'Edit Sales Data' if is_edit else 'Add Sales Data' }}</h2>
        <form method="post" id="salesForm" action="{{ url_for('sales_data.edit_sales', index=index) if is_edit else url_for('sales_data.add_sales') }}">
            <input type="hidden" name="index" id="index" value="{{ index if is_edit else '' }}">
            <div class="form-group">
                <label for="year">Year:</label>
                <input type="number" name="year" id="year" class="form-control" value="{{ sales_data.iloc[0].Year if is_edit else '' }}" required>
            </div>
            <div class="form-group">
                <label for="month">Month:</label>
                <select name="month" id="month" class="form-control" required>
                    {% for month in ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                        <option value="{{ month }}" {% if is_edit and sales_data.iloc[0].Month == month %}selected{% endif %}>{{ month }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="sales">Sales Amount (€):</label>
                <input type="number" name="sales" id="sales" class="form-control" value="{{ sales_data.iloc[0].Sales if is_edit else '' }}" required>
            </div>
            <div class="form-group">
                <label for="category">Category:</label>
                <select name="category" id="category" class="form-control" required>
                    {% for cat in categories %}
                        <option value="{{ cat }}" {% if is_edit and sales_data.iloc[0].Category == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{super()}}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    let selectedIndex = null;
    let selectedCategory = null;
    let selectedYear = null;
    let selectedMonth = null;
    let selectedSales = null;

    document.addEventListener('DOMContentLoaded', function() {
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('click', function() {
                selectRow(
                    this,
                    this.getAttribute('data-index'),
                    this.getAttribute('data-category'),
                    this.getAttribute('data-year'),
                    this.getAttribute('data-month'),
                    this.getAttribute('data-sales')
                );
            });
        });
    });

    function selectRow(row, index, category, year, month, sales) {
        const allRows = document.querySelectorAll('tbody tr');
        allRows.forEach(r => r.classList.remove('table-active'));
        row.classList.add('table-active');
        selectedIndex = index;
        selectedCategory = category;
        selectedYear = year;
        selectedMonth = month;
        selectedSales = sales;
    }

    function openAddModal() {
        document.getElementById('salesModalLabel').textContent = 'Add Sales Data';
        document.getElementById('salesForm').reset();
        document.getElementById('index').value = '';
        document.getElementById('salesForm').action = "{{ url_for('sales_data.add_sales') }}";
        document.getElementById('salesModal').style.display = 'block';
    }

    function openEditModal() {
        if (selectedIndex === null) {
            alert('Please select a row to edit.');
            return;
        }
        document.getElementById('salesModalLabel').textContent = 'Edit Sales Data';
        document.getElementById('year').value = selectedYear;
        document.getElementById('month').value = selectedMonth;
        document.getElementById('sales').value = selectedSales;
        document.getElementById('category').value = selectedCategory;
        document.getElementById('index').value = selectedIndex;
        document.getElementById('salesForm').action = `/edit-sales/${selectedIndex}`;
        document.getElementById('salesModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('salesModal').style.display = 'none';
    }

    function deleteEntry() {
        if (selectedIndex === null) {
            alert('Please select a row to delete.');
            return;
        }
        if (confirm('Are you sure you want to delete this entry?')) {
            window.location.href = `/delete-sales/${selectedIndex}`;
        }
    }

    // Close the modal if clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('salesModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}